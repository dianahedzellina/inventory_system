<?php
session_start();

/* ===== ADMIN CHECK ===== */
if (!isset($_SESSION['user_id'])) {
    header("Location: ../../auth/login.php");
    exit;
}
if ($_SESSION['role'] !== 'admin') {
    header("Location: ../../index.php");
    exit;
}

include '../../database.php';

/* ===== GET BORROW ID ===== */
$borrow_id = isset($_GET['id']) ? (int)$_GET['id'] : 0;

if ($borrow_id <= 0) {
    header("Location: return_requests.php");
    exit;
}

/* ===== FETCH BORROW RECORD (MUST BE RETURN_REQUESTED) ===== */
$stmt = $conn->prepare("
    SELECT item_id, quantity
    FROM borrow_transactions
    WHERE borrow_id = ? AND status = 'return_requested'
    LIMIT 1
");
$stmt->bind_param("i", $borrow_id);
$stmt->execute();
$result = $stmt->get_result();
$borrow = $result->fetch_assoc();
$stmt->close();

if (!$borrow) {
    header("Location: return_requests.php");
    exit;
}

$item_id = (int)$borrow['item_id'];
$qty     = (int)$borrow['quantity'];

/* ===== UPDATE BORROW STATUS ===== */
$stmt = $conn->prepare("
    UPDATE borrow_transactions
    SET status = 'returned',
        return_date = NOW()
    WHERE borrow_id = ?
");
$stmt->bind_param("i", $borrow_id);
$stmt->execute();
$stmt->close();

/* ===== RESTORE ITEM STOCK ===== */
$stmt = $conn->prepare("
    UPDATE items
    SET quantity = quantity + ?
    WHERE item_id = ?
");
$stmt->bind_param("ii", $qty, $item_id);
$stmt->execute();
$stmt->close();

/* ===== ACTIVITY LOG ===== */
$admin_id = $_SESSION['user_id'];
$action   = "Approved return request (Borrow ID: $borrow_id)";

$stmt = $conn->prepare("
    INSERT INTO activity_logs (user_id, action)
    VALUES (?, ?)
");
$stmt->bind_param("is", $admin_id, $action);
$stmt->execute();
$stmt->close();

/* ===== REDIRECT ===== */
header("Location: return_requests.php?approved=1");
exit;
